<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classic Traveller Character Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            height: 100vh;
            overflow: hidden;
            line-height: 1.4;
        }
        
        .terminal-container {
            display: grid;
            grid-template-areas: 
                "header header"
                "sidebar right-top"
                "sidebar right-middle"
                "sidebar right-bottom";
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto 1fr 1fr 1fr;
            height: 100vh;
            gap: 2px;
            background: #000;
        }
        
        .panel {
            background: #000;
            border: 1px solid #0f0;
            padding: 15px;
            overflow-y: auto;
        }
        
        .header {
            grid-area: header;
            text-align: center;
            font-family: 'Orbitron', 'Courier New', monospace;
            font-size: 24px;
            font-weight: 900;
            padding: 10px;
            border-bottom: 2px solid #0f0;
            letter-spacing: 2px;
        }
        
        .sidebar {
            grid-area: sidebar;
            border-right: 2px solid #0f0;
        }
        
        .right-top {
            grid-area: right-top;
        }
        
        .right-middle {
            grid-area: right-middle;
            border-top: 2px solid #0f0;
        }
        
        .right-bottom {
            grid-area: right-bottom;
            border-top: 2px solid #0f0;
        }
        
        .card {
            border: 1px solid #0f0;
            margin: 10px 0;
            padding: 20px;
            text-align: center;
            font-size: 48px;
            font-weight: bold;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sidebar-content {
            padding: 0;
        }
        
        .section {
            border-bottom: 1px solid #666;
            margin-bottom: 10px;
            padding-bottom: 10px;
        }
        
        .section:last-child {
            border-bottom: none;
        }
        
        .section-title {
            color: #fff;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: uppercase;
            text-align: center;
            border-bottom: 1px solid #666;
            padding-bottom: 5px;
        }
        
        .btn {
            background: #000;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 8px 16px;
            margin: 3px 0;
            width: 100%;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #0f0;
            color: #000;
        }
        
        .character-record {
            color: #0f0;
            font-size: 14px;
        }
        
        .character-header {
            margin-bottom: 15px;
            border-bottom: 1px solid #666;
            padding-bottom: 10px;
        }
        
        .character-name-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .title-rank-name {
            font-weight: bold;
        }
        
        .upp-age-terms {
            font-family: 'Courier New', monospace;
        }
        
        .character-section {
            margin-bottom: 10px;
            padding: 5px 0;
        }
        
        .section-label {
            color: #fff;
            font-weight: bold;
            border-bottom: 1px solid #333;
            padding-bottom: 3px;
        }
        
        .event-record {
            color: #0f0;
            font-size: 14px;
        }
        
        .event-section {
            margin-bottom: 10px;
            padding: 5px 0;
        }
        
        .event-label {
            color: #fff;
            font-weight: bold;
            border-bottom: 1px solid #333;
            padding-bottom: 3px;
        }
        
        .term-record {
            color: #0f0;
            font-size: 14px;
        }
        
        .term-header {
            margin-bottom: 15px;
            border-bottom: 1px solid #666;
            padding-bottom: 10px;
        }
        
        .term-title {
            color: #fff;
            font-weight: bold;
        }
        
        .term-section {
            margin-bottom: 20px;
        }
        
        .term-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 2px 0;
        }
        
        .term-action {
            color: #fff;
        }
        
        .term-outcome {
            color: #666;
            font-style: italic;
        }
        
        .muster-header {
            border-top: 1px solid #666;
            padding-top: 10px;
        }
        
        .muster-title {
            color: #fff;
            font-weight: bold;
            border-bottom: 1px solid #333;
            padding-bottom: 3px;
        }
        
        .muster-section {
            margin-top: 15px;
        }
        
        .muster-item {
            color: #fff;
            margin-bottom: 8px;
            padding: 3px 0;
        }
    </style>
</head>
<body>
    <div class="terminal-container">
        <!-- Header -->
        <div class="header">
            Classic Traveller Character Generator
        </div>
        
        <!-- Left Sidebar -->
        <div class="panel sidebar">
            <div class="sidebar-content">
                <!-- Add this to the sidebar, e.g. at the top of sidebar-content -->
                <div class="section" id="sidebar-character-title-section">
                    <span id="sidebar-rank-title"></span><span id="sidebar-name-left"></span>
                </div>
                <!-- Create Character -->
                <div class="section">
                    <button class="btn" id="create-character-btn">Create Character</button>
                </div>
                
                <!-- Characteristics -->
                <div class="section" id="characteristics-section">
                    <div class="section-title">Characteristics</div>
                    <button class="btn" id="strength-btn">Strength</button>
                    <button class="btn" id="dexterity-btn">Dexterity</button>
                    <button class="btn" id="endurance-btn">Endurance</button>
                    <button class="btn" id="intelligence-btn">Intelligence</button>
                    <button class="btn" id="education-btn">Education</button>
                    <button class="btn" id="social-btn">Social</button>
                </div>
                
                <!-- Enlistment -->
                <div class="section">
                    <div class="section-title">Enlistment</div>
                    <button class="btn" id="navy-btn">Navy</button>
                    <button class="btn" id="marines-btn">Marines</button>
                    <button class="btn" id="army-btn">Army</button>
                    <button class="btn" id="scouts-btn">Scouts</button>
                    <button class="btn" id="merchants-btn">Merchants</button>
                    <button class="btn" id="others-btn">Others</button>
                </div>
                
                <!-- Term -->
                <div class="section">
                    <div class="section-title">Term</div>
                    <button class="btn" id="survival-btn">Survival</button>
                    <button class="btn" id="commission-btn">Commission</button>
                    <button class="btn" id="promotion-btn">Promotion</button>
                </div>
                
                <!-- Skills -->
                <div class="section">
                    <div class="section-title">Skills</div>
                    <button class="btn" id="personal-btn">Personal</button>
                    <button class="btn" id="service-btn">Service</button>
                    <button class="btn" id="advanced-btn">Advanced</button>
                    <button class="btn" id="education-skill-btn">Education</button>
                </div>
                
                <!-- Ageing & Reenlist -->
                <div class="section">
                    <button class="btn" id="ageing-btn" style="display: none;">Ageing</button>
                    <button class="btn" id="reenlist-btn">Reenlist</button>
                </div>
                
                <!-- Mustering Out -->
                <div class="section">
                    <div class="section-title">Mustering Out</div>
                    <button class="btn" id="benefits-btn">Benefits</button>
                </div>
                
                <!-- Delete Character -->
                <div class="section">
                    <button class="btn" id="delete-character-btn">Delete Character</button>
                </div>
            </div>
        </div>
        
        <!-- Right Top -->
        <div class="panel right-top">
            <div class="character-record" id="character-record">
                <div class="character-header">
                    <div class="character-name-line">
                        <span id="char-rank" style="margin-right: 6px;"></span>
                        <span class="title-rank-name" id="char-name">Title, Rank, Name</span>
                        <span id="char-service" style="margin-left: 10px;">Service</span>
                        <span class="upp-profile" style="font-family:'Courier New',monospace;">
                            <span id="upp-label">UPP</span>
                            <span id="upp-string">______</span>
                            <span class="upp-age" id="char-age">Age</span>
                            <span class="upp-terms" id="char-terms">Terms</span>
                        </span>
                        <span id="char-rank-number" style="margin-left: 12px;"></span>
                        <span id="top-skill-eligibility" style="margin-left: 12px; color: #0ff; font-size: 16px; font-weight: bold;"></span>
                    </div>
                </div>
                
                <div class="character-section">
                    <div class="section-label">Skills</div>
                </div>
                
                <div class="character-section">
                    <div class="section-label">Mustering Out</div>
                </div>
                
                <div class="character-section">
                    <div class="section-label">Credits</div>
                </div>
                
                <div class="character-section">
                    <div class="section-label">Retirement Income</div>
                </div>
                
                <div class="character-section">
                    <div class="section-label">Possessions</div>
                </div>
                
                <div class="character-section">
                    <div class="section-label">Benefits</div>
                </div>
            </div>
        </div>
        
        <!-- Right Middle -->
        <div class="panel right-middle">
            <div class="event-record">
                <div class="event-section">
                    <div class="event-label">Conditions</div>
                </div>
                
                <div class="event-section">
                    <div class="event-label">Test</div>
                </div>
                
                <div class="event-section">
                    <div class="event-label">Target</div>
                </div>
                
                <div class="event-section">
                    <div class="event-label">Roll</div>
                </div>
                
                <div class="event-section">
                    <div class="event-label">Modifiers</div>
                </div>
                
                <div class="event-section">
                    <div class="event-label">Outcome</div>
                </div>
            </div>
        </div>
        
        <!-- Right Bottom -->
        <div class="panel right-bottom">
            <div class="term-record">
                <!-- Current Term Layout -->
                <div class="term-display">
                    <div class="term-header">
                        <div class="term-title">Current Term</div>
                    </div>
                    
                    <div class="term-section">
                        <div class="term-item">
                            <span class="term-action">Survival</span>
                            <span class="term-outcome">&lt;outcome&gt;</span>
                        </div>
                        <div class="term-item">
                            <span class="term-action">Commission</span>
                            <span class="term-outcome">&lt;outcome&gt;</span>
                        </div>
                        <div class="term-item">
                            <span class="term-action">Promotion</span>
                            <span class="term-outcome">&lt;outcome&gt;</span>
                        </div>
                        <div class="term-item">
                            <span class="term-action">Skills</span>
                            <span class="term-outcome">&lt;outcomes&gt;</span>
                        </div>
                        <div class="term-item">
                            <span class="term-action">Ageing</span>
                            <span class="term-outcome">&lt;outcomes&gt;</span>
                        </div>
                        <div class="term-item">
                            <span class="term-action">Reenlistment</span>
                            <span class="term-outcome">&lt;outcome&gt;</span>
                        </div>
                    </div>
                </div>
                
                <!-- Alternative: Mustering Out Layout -->
                <div class="muster-display" style="display: none;">
                    <div class="muster-header">
                        <div class="muster-title">Mustering Out</div>
                    </div>
                    
                    <div class="muster-section">
                        <div class="muster-item">Cash</div>
                        <div class="muster-item">Pension</div>
                        <div class="muster-item">Acquisitions</div>
                        <div class="muster-item">Benefits</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.getElementById('create-character-btn').onclick = function() {
            fetch('/api/create_character', {method: 'POST'})
                .then(res => res.json())
                .then(data => {
                    document.getElementById('char-name').textContent = data.name;
                    document.getElementById('char-age').textContent = 'Age: ' + data.age;
                    document.getElementById('char-terms').textContent = 'Terms: ' + data.terms_served;
                    document.getElementById('upp-string').textContent = data.upp || '______';
                    document.getElementById('char-service').textContent = 'Service';
                    updateSidebarRankTitle(null, data.name, null);
                });
        };

        // Helper to update the UPP string in the UI
        function updateUPPSlot(index, hexChar) {
            let upp = document.getElementById('upp-string').textContent.split('');
            upp[index] = hexChar;
            document.getElementById('upp-string').textContent = upp.join('');
        }

        // Map characteristic to UPP slot index
        const charToUPPIndex = {
            'strength': 0,
            'dexterity': 1,
            'endurance': 2,
            'intelligence': 3,
            'education': 4,
            'social': 5
        };

        // Track how many characteristic buttons remain
        let remainingCharButtons = 6;

        function setupCharacteristicButton(btnId, charName) {
            document.getElementById(btnId).onclick = function() {
                fetch('/api/generate_characteristic', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({characteristic: charName})
                })
                .then(res => res.json())
                .then(data => {
                    // Hide the button
                    document.getElementById(btnId).style.display = 'none';
                    remainingCharButtons--;
                    // Only update the UPP string when the last characteristic is rolled
                    if (data.upp) {
                        document.getElementById('upp-string').textContent = data.upp;
                    }
                    // If this was the last button, hide the whole section
                    if (remainingCharButtons === 0) {
                        document.getElementById('characteristics-section').style.display = 'none';
                    }
                });
            };
        }

        setupCharacteristicButton('strength-btn', 'strength');
        setupCharacteristicButton('dexterity-btn', 'dexterity');
        setupCharacteristicButton('endurance-btn', 'endurance');
        setupCharacteristicButton('intelligence-btn', 'intelligence');
        setupCharacteristicButton('education-btn', 'education');
        setupCharacteristicButton('social-btn', 'social');

        // Enlistment button setup (add this after your characteristic setup)
        function setupEnlistmentButton(btnId, serviceName) {
            document.getElementById(btnId).onclick = function() {
                fetch('/api/enlist', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({service: serviceName})
                })
                .then(res => res.json())
                .then(data => {
                    // Hide all enlistment buttons
                    document.getElementById('navy-btn').style.display = 'none';
                    document.getElementById('marines-btn').style.display = 'none';
                    document.getElementById('army-btn').style.display = 'none';
                    document.getElementById('scouts-btn').style.display = 'none';
                    document.getElementById('merchants-btn').style.display = 'none';
                    document.getElementById('others-btn').style.display = 'none';
                    // Show result in the event record area
                    if (data.success) {
                        // Show service and outcome after the word Service
                        const service = data.enlistment_result.assigned_service || data.career || '';
                        const outcome = data.enlistment_result.outcome || '';
                        document.getElementById('char-service').textContent = `Service: ${service} (${outcome})`;
                        // Update top bar and sidebar with service and blank rank (enlisted, not commissioned)
                        const name = document.getElementById('char-name').textContent;
                        updateRankDisplay(0, service); // 0 = no rank yet
                        updateSidebarRankTitle(0, name, service);
                        // Populate the event-record middle panel
                        const result = data.enlistment_result;
                        const eventSections = document.querySelectorAll('.event-record .event-section');
                        if (eventSections.length >= 6) {
                            eventSections[0].querySelector('.event-label').textContent = 'Conditions: ' + (result.modifier_details && result.modifier_details.length ? result.modifier_details.join(', ') : 'None');
                            eventSections[1].querySelector('.event-label').textContent = 'Test: Enlistment';
                            eventSections[2].querySelector('.event-label').textContent = 'Target: ' + (result.target !== undefined ? result.target : '');
                            eventSections[3].querySelector('.event-label').textContent = 'Roll: ' + (result.roll !== undefined ? result.roll : '');
                            eventSections[4].querySelector('.event-label').textContent = 'Modifiers: ' + (result.modifier !== undefined ? result.modifier : '');
                            // Explicitly update the Outcome field
                            eventSections.forEach(section => {
                                const label = section.querySelector('.event-label');
                                if (label && label.textContent.trim().startsWith('Outcome')) {
                                    label.textContent = 'Outcome: ' + (result.outcome || '');
                                }
                            });
                        }
                    } else {
                        alert(data.error || "Enlistment failed.");
                    }
                });
            };
        }

        setupEnlistmentButton('navy-btn', 'Navy');
        setupEnlistmentButton('marines-btn', 'Marines');
        setupEnlistmentButton('army-btn', 'Army');
        setupEnlistmentButton('scouts-btn', 'Scouts');
        setupEnlistmentButton('merchants-btn', 'Merchants');
        setupEnlistmentButton('others-btn', 'Others');

        // Map service and rank number to title
        const serviceRankTitles = {
            Navy:       ['', 'Ensign', 'Lieutenant', 'Lt Cmdr', 'Commander', 'Captain', 'Admiral'],
            Army:       ['', 'Lieutenant', 'Captain', 'Major', 'Lt Colonel', 'Colonel', 'General'],
            Marines:    ['', 'Lieutenant', 'Captain', 'Major', 'Lt Colonel', 'Colonel', 'General'],
            Merchants:  ['', '4th Officer', '3rd Officer', '2nd Officer', '1st Officer', 'Captain'],
            Scouts:     ['', ''],
            Others:     ['', '']
        };

        function updateRankDisplay(rank, service) {
            let rankText = '';
            if (rank && service && serviceRankTitles[service] && serviceRankTitles[service][rank]) {
                rankText = serviceRankTitles[service][rank];
            }
            // Left: Rank title
            document.getElementById('char-rank').textContent = rankText ? rankText : '';
            // Right: Rank number
            document.getElementById('char-rank-number').textContent = (rank && rank > 0) ? `Rank: ${rank}` : '';
        }

        function updateSidebarRankTitle(rank, name, service) {
            let title = '';
            if (rank && service && serviceRankTitles[service] && serviceRankTitles[service][rank]) {
                title = serviceRankTitles[service][rank] + ' ';
            }
            document.getElementById('sidebar-rank-title').textContent = title;
            document.getElementById('sidebar-name-left').textContent = name || '';
        }

        // Helper to render the skills list in the top panel
        function renderSkills(skills) {
            // Find the skills section by looking for the section-label that contains "Skills"
            const skillsLabels = document.querySelectorAll('.section-label');
            let skillsSection = null;
            for (let label of skillsLabels) {
                if (label.textContent.includes('Skills')) {
                    skillsSection = label.parentElement;
                    break;
                }
            }
            
            if (!skillsSection) return;
            
            let skillsList = skills && Object.keys(skills).length > 0
                ? Object.entries(skills).map(([name, level]) => `<div>${name} - ${level}</div>`).join('')
                : '<div>No skills yet</div>';
            
            // Remove any existing list
            let oldList = skillsSection.querySelector('.skills-list');
            if (oldList) oldList.remove();
            
            // Add new list
            const div = document.createElement('div');
            div.className = 'skills-list';
            div.innerHTML = skillsList;
            skillsSection.appendChild(div);
        }

        // Helper to show/hide only available skill table buttons
        function updateSkillButtons(availableTables) {
            const skillButtonMap = {
                personal: 'personal-btn',
                service: 'service-btn',
                advanced: 'advanced-btn',
                education: 'education-skill-btn'
            };
            Object.entries(skillButtonMap).forEach(([table, btnId]) => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.style.display = (availableTables && availableTables[table]) ? '' : 'none';
                }
            });
        }

        // Hybrid approach: Frontend manages immediate UI, backend remains source of truth
        let frontendSkillEligibility = 0;
        let syncInProgress = false;
        let ageingTriggered = false; // Add guard to prevent multiple ageing calls

        // Helper to update skill eligibility counter in sidebar
        function updateSkillEligibilityCounter(skillEligibility) {
            let prev = frontendSkillEligibility;
            frontendSkillEligibility = skillEligibility;
            let counter = document.getElementById('skill-eligibility-counter');
            if (!counter) {
                counter = document.createElement('div');
                counter.id = 'skill-eligibility-counter';
                counter.className = 'section-title';
                // Find the skills section in the sidebar
                const skillsLabels = document.querySelectorAll('.section-title');
                let skillsSection = null;
                for (let label of skillsLabels) {
                    if (label.textContent.includes('Skills')) {
                        skillsSection = label.parentElement;
                        break;
                    }
                }
                if (skillsSection) {
                    skillsSection.insertBefore(counter, skillsSection.firstChild);
                }
            }
            counter.textContent = `Skill Rolls Left: ${skillEligibility}`;
            // Update the top panel counter
            let topCounter = document.getElementById('top-skill-eligibility');
            if (topCounter) {
                topCounter.textContent = `Skill Rolls: ${skillEligibility}`;
                topCounter.style.display = skillEligibility > 0 ? '' : 'none';
                // Animate if incremented
                if (skillEligibility > prev) {
                    topCounter.style.transition = 'background 0.3s, color 0.3s';
                    topCounter.style.background = '#0ff';
                    topCounter.style.color = '#000';
                    setTimeout(() => {
                        topCounter.style.background = '';
                        topCounter.style.color = '#0ff';
                    }, 400);
                }
            }
            // Hide skill buttons when eligibility reaches 0
            if (skillEligibility <= 0) {
                const skillButtons = ['personal-btn', 'service-btn', 'advanced-btn', 'education-skill-btn'];
                skillButtons.forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        btn.style.display = 'none';
                    }
                });
                // Hide the skills card/section if present
                let skillsSection = null;
                const skillsLabels = document.querySelectorAll('.section-title');
                for (let label of skillsLabels) {
                    if (label.textContent.includes('Skills')) {
                        skillsSection = label.parentElement;
                        break;
                    }
                }
                if (skillsSection) {
                    skillsSection.style.display = 'none';
                }
                
                // Only trigger ageing once when eligibility first reaches zero
                if (!ageingTriggered) {
                    ageingTriggered = true;
                    
                    // Check if we need ageing checks (term 4+)
                    const currentAge = parseInt(document.getElementById('char-age').textContent.match(/\d+/)[0]);
                    const termsServed = parseInt(document.getElementById('char-terms').textContent.match(/\d+/)[0]);
                    
                    if (termsServed >= 4) {
                        // Show ageing button for term 4+
                        const ageingBtn = document.getElementById('ageing-btn');
                        if (ageingBtn) {
                            ageingBtn.style.display = '';
                        }
                        // Trigger ageing process
                        fetch('/api/ageing', { method: 'POST' })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    // Display ageing results in the event record panel
                                    const eventSections = document.querySelectorAll('.event-record .event-section');
                                    if (eventSections.length >= 6) {
                                        eventSections[0].querySelector('.event-label').textContent = 'Ageing Check';
                                        eventSections[1].querySelector('.event-label').textContent = 'Previous Age: ' + (data.ageing_result.previous_age || '');
                                        eventSections[2].querySelector('.event-label').textContent = 'Current Age: ' + (data.ageing_result.current_age || '');
                                        eventSections[3].querySelector('.event-label').textContent = 'Effects: ' + (Array.isArray(data.ageing_result.ageing_effects) ? data.ageing_result.ageing_effects.join(', ') : 'None');
                                        eventSections[4].querySelector('.event-label').textContent = 'Total Effects: ' + (data.ageing_result.total_effects || 0);
                                        eventSections[5].querySelector('.event-label').textContent = '';
                                    }
                                    // Update age in the character record UI
                                    if (data.character && typeof data.character.age !== 'undefined') {
                                        document.getElementById('char-age').textContent = 'Age: ' + data.character.age;
                                    }
                                    // Optionally update stats/UPP if needed
                                    if (data.character && data.character.upp) {
                                        document.getElementById('upp-string').textContent = data.character.upp;
                                    }
                                } else {
                                    alert(data.error || 'Ageing process failed.');
                                }
                            });
                    } else {
                        // For terms 0-3, just increment age by 4 without ageing checks
                        const newAge = currentAge + 4;
                        document.getElementById('char-age').textContent = 'Age: ' + newAge;
                        
                        // Display simple age increment in event record
                        const eventSections = document.querySelectorAll('.event-record .event-section');
                        if (eventSections.length >= 6) {
                            eventSections[0].querySelector('.event-label').textContent = 'Age Increment';
                            eventSections[1].querySelector('.event-label').textContent = 'Previous Age: ' + currentAge;
                            eventSections[2].querySelector('.event-label').textContent = 'Current Age: ' + newAge;
                            eventSections[3].querySelector('.event-label').textContent = 'Effects: None (too young)';
                            eventSections[4].querySelector('.event-label').textContent = 'Total Effects: 0';
                            eventSections[5].querySelector('.event-label').textContent = '';
                        }
                    }
                }
            }
        }

        // Update skill UI after backend event
        function updateSkillUIFromBackend(data) {
            console.log('updateSkillUIFromBackend called with:', data);
            
            if (data.available_tables) {
                console.log('Updating available tables:', data.available_tables);
                updateSkillButtons(data.available_tables);
            }
            if (typeof data.skill_eligibility === 'number') {
                console.log(`Updating skill eligibility from ${frontendSkillEligibility} to ${data.skill_eligibility}`);
                updateSkillEligibilityCounter(data.skill_eligibility);
            }
        }

        // Patch setSkillUIVisibility to also update available tables
        function setSkillUIVisibility(ready, availableTables, skillEligibility) {
            updateSkillButtons(availableTables);
            let counter = document.getElementById('skill-eligibility-counter');
            if (counter) {
                counter.style.display = ready ? '' : 'none';
            }
            if (typeof skillEligibility === 'number') {
                updateSkillEligibilityCounter(skillEligibility);
            }
            
            // Show/hide the skills section based on readiness
            const skillsSection = document.querySelector('.section-title');
            if (skillsSection && skillsSection.textContent.includes('Skills')) {
                const skillsParent = skillsSection.parentElement;
                if (ready) {
                    skillsParent.style.display = '';
                } else {
                    skillsParent.style.display = 'none';
                }
            }
        }

        // Call /api/resolve_skill and update UI with hybrid approach
        function resolveSkill(table) {
            if (syncInProgress) return; // Prevent double-clicks
            
            console.log(`Starting skill roll for ${table}. Frontend eligibility before: ${frontendSkillEligibility}`);
            
            // Optimistic update - decrement immediately
            frontendSkillEligibility--;
            updateSkillEligibilityCounter(frontendSkillEligibility);
            
            console.log(`Frontend eligibility after decrement: ${frontendSkillEligibility}`);
            
            syncInProgress = true;
            fetch('/api/resolve_skill', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ table })
            })
            .then(res => res.json())
            .then(data => {
                console.log('Backend response:', data);
                
                if (!data.success) {
                    // Rollback on error
                    frontendSkillEligibility++;
                    updateSkillEligibilityCounter(frontendSkillEligibility);
                    console.log(`Error occurred. Frontend eligibility after rollback: ${frontendSkillEligibility}`);
                    alert(data.error || 'Skill roll failed.');
                    return;
                }
                
                // Sync with backend data
                const backendEligibility = data.skill_eligibility;
                console.log(`Backend eligibility: ${backendEligibility}, Frontend before sync: ${frontendSkillEligibility}`);
                
                frontendSkillEligibility = backendEligibility;
                updateSkillEligibilityCounter(frontendSkillEligibility);
                updateSkillButtons(data.available_tables);
                
                console.log(`Frontend eligibility after sync: ${frontendSkillEligibility}`);
                
                // Update skills list in top panel
                renderSkills(data.skills);
                
                // Show result in the middle panel (event transparency)
                const eventSections = document.querySelectorAll('.event-record .event-section');
                if (eventSections.length >= 6) {
                    eventSections[0].querySelector('.event-label').textContent = `Skill Table: ${table}`;
                    eventSections[1].querySelector('.event-label').textContent = `Roll: ${data.skill_result.roll}`;
                    eventSections[2].querySelector('.event-label').textContent = `Result: ${data.skill_result.skill_gained}`;
                    eventSections[3].querySelector('.event-label').textContent = `Type: ${data.skill_result.result_type}`;
                    eventSections[4].querySelector('.event-label').textContent = `Level: ${data.skill_result.level || ''}`;
                    eventSections[5].querySelector('.event-label').textContent = `Eligibilities Left: ${data.skill_eligibility}`;
                }
            })
            .catch(error => {
                // Rollback on network error
                frontendSkillEligibility++;
                updateSkillEligibilityCounter(frontendSkillEligibility);
                console.log(`Network error. Frontend eligibility after rollback: ${frontendSkillEligibility}`);
                alert('Network error. Please try again.');
            })
            .finally(() => {
                syncInProgress = false;
            });
        }

        // Wire up existing skill buttons in sidebar
        document.getElementById('personal-btn').onclick = function() {
            resolveSkill('personal');
        };
        document.getElementById('service-btn').onclick = function() {
            resolveSkill('service');
        };
        document.getElementById('advanced-btn').onclick = function() {
            resolveSkill('advanced');
        };
        document.getElementById('education-skill-btn').onclick = function() {
            resolveSkill('education');
        };

        // Initial setup for skills - update eligibility counter after character creation
        // function setupSkillsAfterCharacterCreation() {
        //     // This will be called after character creation to set initial skill eligibility
        //     // For now, we'll assume 0 eligibilities until the character has a career
        //     updateSkillEligibilityCounter(0);
        // }

        // Remove the call to setupSkillsAfterCharacterCreation after character creation
        const originalCreateCharacter = document.getElementById('create-character-btn').onclick;
        document.getElementById('create-character-btn').onclick = function() {
            originalCreateCharacter.call(this);
            // setupSkillsAfterCharacterCreation(); // <-- REMOVED
        };

        // Setup survival button
        function setupSurvivalButton() {
            document.getElementById('survival-btn').onclick = function() {
                fetch('/api/survival', {
                    method: 'POST'
                })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('survival-btn').style.display = 'none';
                    if (data.success) {
                        const result = data.survival_result;
                        if (result.outcome === 'survived' && 'terms_served' in data) {
                            document.getElementById('char-terms').textContent = 'Terms: ' + data.terms_served;
                        }
                        setSkillUIVisibility(data.ready_for_skills, data.available_tables, data.skill_eligibility);
                        updateSkillUIFromBackend(data);
                        const eventSections = document.querySelectorAll('.event-record .event-section');
                        if (eventSections.length >= 6) {
                            eventSections[0].querySelector('.event-label').textContent = 'Conditions: ' + (result.modifier_details && result.modifier_details.length ? result.modifier_details.join(', ') : 'None');
                            eventSections[1].querySelector('.event-label').textContent = 'Test: Survival';
                            eventSections[2].querySelector('.event-label').textContent = 'Target: ' + (result.target !== undefined ? result.target : '');
                            eventSections[3].querySelector('.event-label').textContent = 'Roll: ' + (result.roll !== undefined ? result.roll : '');
                            eventSections[4].querySelector('.event-label').textContent = 'Modifiers: ' + (result.modifier !== undefined ? result.modifier : '');
                            eventSections.forEach(section => {
                                const label = section.querySelector('.event-label');
                                if (label && label.textContent.trim().startsWith('Outcome')) {
                                    label.textContent = 'Outcome: ' + (result.outcome || '');
                                }
                            });
                        }
                    } else {
                        alert(data.error || "Survival check failed.");
                    }
                });
            };
        }

        // Setup commission button
        function setupCommissionButton() {
            document.getElementById('commission-btn').onclick = function() {
                fetch('/api/commission', {
                    method: 'POST'
                })
                .then(res => res.json())
                .then(data => {
                    // Always hide commission button after use (commission only happens once)
                    document.getElementById('commission-btn').style.display = 'none';
                    
                    if (data.success) {
                        const result = data.commission_result;
                        
                        // If commission was successful, show promotion button
                        if (result.success) {
                            document.getElementById('promotion-btn').style.display = '';
                        }
                        
                        const service = result.career;
                        const name = document.getElementById('char-name').textContent;
                        updateRankDisplay(result.rank, service);
                        updateSidebarRankTitle(result.rank, name, service);
                        setSkillUIVisibility(data.ready_for_skills, data.available_tables, data.skill_eligibility);
                        updateSkillUIFromBackend(data);
                        const eventSections = document.querySelectorAll('.event-record .event-section');
                        if (eventSections.length >= 6) {
                            eventSections[0].querySelector('.event-label').textContent = 'Conditions: ' + (result.modifier_details && result.modifier_details.length ? result.modifier_details.join(', ') : 'None');
                            eventSections[1].querySelector('.event-label').textContent = 'Test: Commission';
                            eventSections[2].querySelector('.event-label').textContent = 'Target: ' + (result.target !== undefined ? result.target : '');
                            eventSections[3].querySelector('.event-label').textContent = 'Roll: ' + (result.roll !== undefined ? result.roll : '');
                            eventSections[4].querySelector('.event-label').textContent = 'Modifiers: ' + (result.modifier !== undefined ? result.modifier : '');
                            eventSections.forEach(section => {
                                const label = section.querySelector('.event-label');
                                if (label && label.textContent.trim().startsWith('Outcome')) {
                                    label.textContent = 'Outcome: ' + (result.outcome || '');
                                }
                            });
                        }
                    } else {
                        alert(data.error || "Commission check failed.");
                    }
                });
            };
        }

        // Setup promotion button
        function setupPromotionButton() {
            document.getElementById('promotion-btn').onclick = function() {
                fetch('/api/promotion', {
                    method: 'POST'
                })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('promotion-btn').style.display = 'none';
                    if (data.success) {
                        const result = data.promotion_result;
                        const service = result.career;
                        const name = document.getElementById('char-name').textContent;
                        updateRankDisplay(result.rank, service);
                        updateSidebarRankTitle(result.rank, name, service);
                        setSkillUIVisibility(data.ready_for_skills, data.available_tables, data.skill_eligibility);
                        updateSkillUIFromBackend(data);
                        const eventSections = document.querySelectorAll('.event-record .event-section');
                        if (eventSections.length >= 6) {
                            eventSections[0].querySelector('.event-label').textContent = 'Conditions: ' + (result.modifier_details && result.modifier_details.length ? result.modifier_details.join(', ') : 'None');
                            eventSections[1].querySelector('.event-label').textContent = 'Test: Promotion';
                            eventSections[2].querySelector('.event-label').textContent = 'Target: ' + (result.target !== undefined ? result.target : '');
                            eventSections[3].querySelector('.event-label').textContent = 'Roll: ' + (result.roll !== undefined ? result.roll : '');
                            eventSections[4].querySelector('.event-label').textContent = 'Modifiers: ' + (result.modifier !== undefined ? result.modifier : '');
                            eventSections.forEach(section => {
                                const label = section.querySelector('.event-label');
                                if (label && label.textContent.trim().startsWith('Outcome')) {
                                    label.textContent = 'Outcome: ' + (result.outcome || '');
                                }
                            });
                        }
                    } else {
                        alert(data.error || "Promotion check failed.");
                    }
                });
            };
        }

        // Setup reenlistment button
        function setupReenlistButton() {
            document.getElementById('reenlist-btn').onclick = function() {
                // Get current terms served
                const termsServed = parseInt(document.getElementById('char-terms').textContent.match(/\d+/)[0]);
                
                // Display reenlistment options in the event record panel
                const eventSections = document.querySelectorAll('.event-record .event-section');
                if (eventSections.length >= 6) {
                    eventSections[0].querySelector('.event-label').textContent = 'Reenlistment Decision';
                    
                    if (termsServed < 5) {
                        // Terms < 5: reenlist or leave
                        eventSections[1].querySelector('.event-label').textContent = 'Choose:';
                        eventSections[2].querySelector('.event-label').textContent = '';
                        eventSections[3].querySelector('.event-label').textContent = '';
                        eventSections[4].querySelector('.event-label').textContent = '';
                        eventSections[5].querySelector('.event-label').textContent = '';
                        
                        // Add reenlistment buttons
                        const reenlistBtn = document.createElement('button');
                        reenlistBtn.textContent = 'Reenlist';
                        reenlistBtn.className = 'btn';
                        reenlistBtn.style.margin = '5px';
                        reenlistBtn.onclick = () => performReenlistment('reenlist');
                        
                        const leaveBtn = document.createElement('button');
                        leaveBtn.textContent = 'Leave';
                        leaveBtn.className = 'btn';
                        leaveBtn.style.margin = '5px';
                        leaveBtn.onclick = () => performReenlistment('discharge');
                        
                        // Clear previous buttons and add new ones
                        eventSections[1].innerHTML = '<div class="event-label">Choose:</div>';
                        eventSections[1].appendChild(reenlistBtn);
                        eventSections[1].appendChild(leaveBtn);
                    } else {
                        // Terms >= 5: reenlist or retire
                        eventSections[1].querySelector('.event-label').textContent = 'Choose:';
                        eventSections[2].querySelector('.event-label').textContent = '';
                        eventSections[3].querySelector('.event-label').textContent = '';
                        eventSections[4].querySelector('.event-label').textContent = '';
                        eventSections[5].querySelector('.event-label').textContent = '';
                        
                        // Add reenlistment buttons
                        const reenlistBtn = document.createElement('button');
                        reenlistBtn.textContent = 'Reenlist';
                        reenlistBtn.className = 'btn';
                        reenlistBtn.style.margin = '5px';
                        reenlistBtn.onclick = () => performReenlistment('reenlist');
                        
                        const retireBtn = document.createElement('button');
                        retireBtn.textContent = 'Retire';
                        retireBtn.className = 'btn';
                        retireBtn.style.margin = '5px';
                        retireBtn.onclick = () => performReenlistment('retire');
                        
                        // Clear previous buttons and add new ones
                        eventSections[1].innerHTML = '<div class="event-label">Choose:</div>';
                        eventSections[1].appendChild(reenlistBtn);
                        eventSections[1].appendChild(retireBtn);
                    }
                }
            };
        }

        // Function to perform the actual reenlistment
        function performReenlistment(preference) {
            fetch('/api/reenlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ preference: preference })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const result = data.reenlistment_result;
                    
                    // Update character info
                    if (data.character) {
                        if (data.character.age) {
                            document.getElementById('char-age').textContent = 'Age: ' + data.character.age;
                        }
                        if (data.character.terms_served !== undefined) {
                            document.getElementById('char-terms').textContent = 'Terms: ' + data.character.terms_served;
                        }
                    }
                    
                    // Display a report in the event record (like commission/promotion)
                    const eventSections = document.querySelectorAll('.event-record .event-section');
                    if (eventSections.length >= 6) {
                        eventSections[0].querySelector('.event-label').textContent = 'Test: Reenlistment';
                        eventSections[1].querySelector('.event-label').textContent = 'Preference: ' + (result.preference || '');
                        eventSections[2].querySelector('.event-label').textContent = 'Target: ' + (result.target !== undefined ? result.target : '');
                        eventSections[3].querySelector('.event-label').textContent = 'Roll: ' + (result.roll !== undefined ? result.roll : '');
                        eventSections[4].querySelector('.event-label').textContent = 'Outcome: ' + (result.outcome || '');
                        eventSections[5].querySelector('.event-label').textContent = 'Status: ' + (result.status_text || '');
                    }

                    // Remove reenlistment dialog buttons after reenlistment
                    if (eventSections.length >= 6) {
                        eventSections.forEach(section => {
                            const buttons = section.querySelectorAll('button');
                            buttons.forEach(button => button.remove());
                        });
                    }
                    
                    // Hide reenlist button if character is discharged/retired
                    if (!result.continue_career) {
                        document.getElementById('reenlist-btn').style.display = 'none';
                    } else {
                        // Reset ageing trigger for new term
                        ageingTriggered = false;
                        
                        // Hide ageing button for new term (will show again at term 4+)
                        document.getElementById('ageing-btn').style.display = 'none';
                        
                        // Reset term buttons for new term
                        document.getElementById('survival-btn').style.display = '';
                        // Only show commission button if not already commissioned
                        if (!data.character.commissioned) {
                            document.getElementById('commission-btn').style.display = '';
                        } else {
                            document.getElementById('commission-btn').style.display = 'none';
                        }
                        // Only show promotion button if commissioned
                        if (data.character.commissioned) {
                            document.getElementById('promotion-btn').style.display = '';
                        } else {
                            document.getElementById('promotion-btn').style.display = 'none';
                        }
                        
                        // Update skill UI with backend data
                        setSkillUIVisibility(data.ready_for_skills, data.available_tables, data.skill_eligibility);
                        updateSkillUIFromBackend(data);
                        
                        // Clear event record for new term (will be filled by next event)
                        // (Do not clear here, let the report show)
                    }
                } else {
                    alert(data.error || 'Reenlistment failed.');
                }
            });
        }

        setupSurvivalButton();
        setupCommissionButton();
        setupPromotionButton();
        setupReenlistButton();
    </script>
</body>
</html>